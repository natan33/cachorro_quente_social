{% extends 'layouts/base.html' %}

{% block title %}Dashboard - Vendas Hot-Dog{% endblock %}

{% block content %}
<div class="row align-items-center mb-4">
    <div class="col-md-6">
        <h2 class="mb-0">Dashboard de Vendas</h2>
    </div>

    <div class="col-md-6 text-end">
        <!-- Botão Nova Venda -->
        <button class="btn btn-success rounded-circle shadow-lg" data-bs-toggle="modal"
            data-bs-target="#registerSaleModal" title="Nova Venda"
            style="width: 50px; height: 50px; font-size: 24px; line-height: 1; padding: 0;">
            +
        </button>

        <!-- Botão Enviar Excel para E-mail -->
        <button class="btn btn-primary rounded-circle shadow-lg ms-2" data-bs-toggle="modal" data-bs-target="#sendExcelModal" 
            title="Enviar Excel para E-mail"
            style="width: 50px; height: 50px; font-size: 24px; line-height: 1; padding: 0;">
            <i class="bi bi-file-earmark-excel"></i> <!-- Ícone de Excel -->
        </button>
    </div>
</div>



<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3 shadow" data-status-filter="1">
            <div class="card-header">Vendas do Dia</div>
            <div class="card-body">
                <h4 class="card-title" id="dailySalesCard">Carregando...</h4>
                <p class="card-text">Total de vendas hoje.</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white bg-success mb-3 shadow" data-status-filter="2">
            <div class="card-header">Total de Vendas (Geral)</div>
            <div class="card-body">
                <h4 class="card-title" id="totalSalesCard">Carregando...</h4>
                <p class="card-text">Total de vendas acumuladas.</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white bg-info mb-3 shadow" data-status-filter="3">
            <div class="card-header">Transações Hoje</div>
            <div class="card-body">
                <h4 class="card-title" id="dailyTransactionsCard">Carregando...</h4>
                <p class="card-text">Número de vendas realizadas hoje.</p>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3 shadow" data-status-filter="4">
            <div class="card-header">Vendas Pagas</div>
            <div class="card-body">
                <h4 class="card-title" id="paidSalesCard">Carregando...</h4>
                <p class="card-text">Quantidade de vendas pagas.</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white bg-danger mb-3 shadow" data-status-filter="5">
            <div class="card-header">Vendas Pendentes</div>
            <div class="card-body">
                <h4 class="card-title" id="pendingSalesCard">Carregando...</h4>
                <p class="card-text">Quantidade de vendas com pagamento pendente.</p>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-white bg-warning mb-3 shadow" data-status-filter="6">
            <div class="card-header">Valor a Receber</div>
            <div class="card-body">
                <h4 class="card-title" id="receivableAmountCard">Carregando...</h4>
                <p class="card-text">Total (R$) de pagamentos pendentes.</p>
            </div>
        </div>
    </div>
</div>




<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Filtros de Vendas</h5>
    </div>
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="startDate" class="form-label">Data Início</label>
                <input type="date" class="form-control" id="startDate">
            </div>

            <div class="col-md-3">
                <label for="productFilter" class="form-label">Produto</label>
                <input type="text" class="form-control" id="productFilter" placeholder="Nome do Produto">
            </div>
            <div class="col-md-3">
                <label for="paymentMethodFilter" name="type_pagamento" class="form-label">Método de Pagamento</label>
                <select id="paymentMethodFilter" name="type_pagamento" class="form-control">
                    <option value="">Selecione...</option>
                </select>

                <!-- opções vão ser carregadas dinamicamente -->
            </div>
            <div class="col-md-3">
                <label for="statusFilter" class="form-label">Status de Pagamento</label>
                <select id="statusFilter" name="status_filter" class="form-control">
                    <option value="">Selecione...</option>
                </select>

                <!-- opções vão ser carregadas dinamicamente -->
            </div>
            <div class="col-md-3">
                <label for="userFilter" class="form-label">Vendedor</label>
                <input type="text" class="form-control" id="userFilter" placeholder="Nome do Vendedor">
            </div>

            


            <div class="col-md-12 text-end">
                
                <button class="btn btn-secondary me-2" id="clearFilters">Limpar Filtros</button>
                <button class="btn btn-primary" id="applyFilters">Aplicar Filtros</button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0">Registros de Vendas</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table id="salesTable" class="table table-striped table-bordered" style="width:100%">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data da Venda</th>
                        <th>Produto</th>
                        <th>Quantidade</th>
                        <th>Preço Unitário</th>
                        <th>Valor Total</th>
                        <th>Método Pagamento</th>
                        <th>Status Pagamento</th>
                        <th>Observações</th>    
                        <th>Comprador</th>
                        <th>Vendedor</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="saleDetailsModal" tabindex="-1" aria-labelledby="saleDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="saleDetailsModalLabel">Detalhes da Venda #<span id="modalSaleId"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Vendedor:</strong> <span id="modalSeller"></span></p>
                <p><strong>Data da Venda:</strong> <span id="modalSaleDate"></span></p>
                <p><strong>Valor Total:</strong> <span id="modalTotalAmount"></span></p>
                <p><strong>Método de Pagamento:</strong> <span id="modalPaymentMethod"></span></p>
                <p><strong>Observações:</strong> <span id="modalNotes"></span></p>

                <h6>Itens da Venda:</h6>
                <table class="table table-bordered table-striped">
                    <thead>
                        <tr>
                            <th>Produto</th>
                            <th>Quantidade</th>
                            <th>Preço Unitário</th>
                            <th>Total Item</th>
                        </tr>
                    </thead>
                    <tbody id="modalSaleItems">
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Registro de Venda -->
<div class="modal fade" id="registerSaleModal" tabindex="-1" aria-labelledby="registerSaleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="registerSaleModalLabel">Registrar Nova Venda</h5>
                <button type="button" 
                    id="fechar-modal-add-venda"
                class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="POST" id="saleForm">
                    {{ register_sale_form.hidden_tag() }}
                    {{ register_sale_form.tP_form }}

                    <!-- Produto fixo -->
                    <div class="mb-3">
                        {{ register_sale_form.product_name.label(class="form-label") }}
                        {{ register_sale_form.product_name(class="form-control", readonly=True, id="productName") }}
                    </div>

                    <div class="mb-3">
                        {{ register_sale_form.buyer .label(class="form-label") }}
                        {{ register_sale_form.buyer (class="form-control", id="buyerName") }}
                    </div>

                    <div class="mb-3">
                        {{ register_sale_form.quantity.label(class="form-label") }}
                        {{ register_sale_form.quantity(class="form-control", id="quantity") }}
                        {% for error in register_sale_form.quantity.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ register_sale_form.payment_method.label(class="form-label") }}
                        {{ register_sale_form.payment_method(class="form-select", id="paymentMethod") }}
                        {% for error in register_sale_form.payment_method.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ register_sale_form.payment_status.label(class="form-label d-block") }}
                        {% for subfield in register_sale_form.payment_status %}
                        <div class="form-check form-check-inline">
                            {# Aqui você pode definir o id manualmente com base no valor do campo #}
                            {% set custom_id = 'paymentPaid' if subfield.data == 'paid' else 'paymentNotPaid' %}
                            {{ subfield(id=custom_id, class="form-check-input") }}
                            {{ subfield.label(class="form-check-label", for=custom_id) }}
                        </div>
                        {% endfor %}
                        {% for error in register_sale_form.payment_status.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>


                    <div class="mb-3">
                        {{ register_sale_form.notes.label(class="form-label") }}
                        {{ register_sale_form.notes(class="form-control", rows="3", id="notes" ) }}
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6 offset-md-6 text-end">
                            <h4>Total da Venda: <span id="totalAmount">R$ 5.00</span></h4>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        {{ register_sale_form.submit(class="btn btn-success btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- Modal de Editar Venda -->
<div class="modal fade" id="EditeSaleModal" tabindex="-1" aria-labelledby="registerSaleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="registerSaleModalLabel">Editar Pedido</h5>
                <button type="button" 
                    id="fechar-modal-edit-venda"
                class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form method="POST" id="saleFormEdit" action="/api/edit_sale">
                    {{ form_edite.hidden_tag() }}
                    {{ form_edite.tP_form }}

                    <!-- Produto fixo -->
                    <div class="mb-3">
                        {{ form_edite.product_name.label(class="form-label") }}
                        {{ form_edite.product_name(class="form-control", readonly=True, id="productNameEdite") }}
                    </div>

                    <div class="mb-3">
                        {{ form_edite.buyer .label(class="form-label") }}
                        {{ form_edite.buyer (class="form-control", id="buyerNameEdite") }}
                    </div>

                    <div class="mb-3">
                        {{ form_edite.quantity.label(class="form-label") }}
                        {{ form_edite.quantity(class="form-control", id="quantityEdite") }}
                        {% for error in form_edite.quantity.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ form_edite.payment_method.label(class="form-label") }}
                        {{ form_edite.payment_method(class="form-select", id="paymentMethodEdite") }}
                        {% for error in form_edite.payment_method.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>

                    <div class="mb-3">
                        {{ form_edite.payment_status.label(class="form-label d-block") }}
                        {% for subfield in form_edite.payment_status %}
                        <div class="form-check form-check-inline">
                            {# Aqui você pode definir o id manualmente com base no valor do campo #}
                            {% set custom_id = 'paymentPaidEdite' if subfield.data == 'paid' else 'paymentNotPaid' %}
                            {{ subfield(id=custom_id, class="form-check-input") }}
                            {{ subfield.label(class="form-check-label", for=custom_id) }}
                        </div>
                        {% endfor %}
                        {% for error in form_edite.payment_status.errors %}
                        <div class="text-danger small">{{ error }}</div>
                        {% endfor %}
                    </div>


                    <div class="mb-3">
                        {{ form_edite.notes.label(class="form-label") }}
                        {{ form_edite.notes(class="form-control", rows="3", id="notesEdite" ) }}
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6 offset-md-6 text-end">
                            <h4>Total da Venda: <span id="totalAmountIdeti">R$ 5.00</span></h4>
                        </div>
                    </div>

                    <div class="d-grid gap-2 mt-4">
                        {{ form_edite.submit(class="btn btn-success btn-lg") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="sendExcelModal" tabindex="-1" aria-labelledby="sendExcelModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="sendExcelModalLabel">Enviar Relatório Excel para E-mail</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="sendExcelForm" enctype="multipart/form-data">
                    <!-- Input para o E-mail -->
                    <div class="mb-3">
                        <label for="email" class="form-label">E-mail</label>
                        <input type="text" class="form-control" id="email" placeholder="Digite o e-mail e pressione Enter">
                        <small class="form-text text-muted">Digite múltiplos e-mails pressionando Enter após cada um.</small>
                    </div>

                    <!-- Exibição dos e-mails inseridos -->
                    <div id="emailListDisplay" class="mb-3"></div> <!-- Aqui os e-mails serão exibidos -->


                    <!-- Botão de Enviar -->
                    <div class="text-end">
                        <button type="submit" class="btn btn-primary" disabled id="sendBtn">Enviar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>




{% endblock %}

{% block scripts %}
 <script type="module" src="{{ vite_asset('pages/dashboard.js') }}"></script>
 <script type="module" src="{{ vite_asset('pages/registro_venda.js') }}"></script>
{% endblock %}